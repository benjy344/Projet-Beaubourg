<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="">
        <meta name="theme-color" content="#999999" />

        <link rel="stylesheet" href="css/codemirror.css">
        <link rel="stylesheet" href="css/icecoder.css">

        <style>

            #wrapper {
                background-color: #ededed;
                padding: 1em;
            }

            .pixel {
                width: 100px;
                height: 100px;
                border: solid 1px black;  
                display: inline-block;
                background-color: black;
                transition: background ease 0.5s;
            }

            .pixelActive {
                border : #008bff solid 2px;
            }

        </style>

        <title>New HMTL document by NewJect</title>

    </head>
    <body>

        <header>HEADER</header>

        <div></div>

        <textarea id="code">
        </textarea>

        <button class="run">RUN</button>

        <div class="buttons">
            <div class="rangeBg">
                <input type="range" value="0" max="255" min="0" step="15" class="red">
            </div>
            <div class="rangeBg">
                <input type="range" value="0" max="255" min="0" step="15" class="green">
            </div>
            <div class="rangeBg">
                <input type="range" value="0" max="255" min="0" step="15" class="blue">
            </div>

        </div>

        <div id="wrapper">
            <div class="pixel"></div>
            <div class="pixel"></div>
            <div class="pixel"></div>

        </div>

        <footer>
            <button id="validate">VALIDATE</button>

        </footer>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script src="js/codemirror.js"></script>
        <script src="js/javascript.js"></script>
        <!--        <script src="js/matchbrackets.js"></script>-->
        <script src="js/script.js"></script>


        <script>

            $(function(){

                var devMode = true;

                //CodeMirror
                var textArea = $('#code')[0];
                var codeConfig = {
                    mode: "text/javascript",
                    theme: "icecoder",
                    lineWrapping: true,
                    lineNumbers: true,
                    autofocus: false
                    //matchBrackets: true
                }

                if (!devMode) {
                    codeConfig.readOnly = 'nocursor';
                }

                var answers;
                var myCodeMirror = CodeMirror.fromTextArea(textArea, codeConfig);

                var value = 0;

                $.getJSON('answers.json', function(data){
                    console.log(data);
                    answers = data.lvl3;

                    console.log(answers);



                    $('#wrapper').children().each(function(){            
                        $(this).data('rvb', {red: value, green: value, blue: value});
                    });

                    if (!devMode) {
                        $('button').hide();
                    } else {
                        $('.buttons').hide(); 
                    }


                    //Change Active Pixel
                    $('.pixel').click(function() {
                        if (!$(this).hasClass('pixelActive')) {
                            $('.pixelActive').removeClass('pixelActive');
                        }
                        $(this).toggleClass('pixelActive');

                        var thisColors = $(this).data('rvb');

                        if ($('.pixelActive').length != 0) {
                            resetSliders(thisColors.red, thisColors.green, thisColors.blue);
                            resetCode('pixel' + $('.pixelActive').index(), thisColors.red, thisColors.green, thisColors.blue);
                            $('.buttons').show();
                        } else {
                            $('.buttons').hide();
                        }
                    })

                    //Run Code
                    $('button.run').click(function(){
                        runCode();
                    });

                    //Validate
                    $('#validate').click(function(){
                        var isCorrect = true;
                        $.each(answers, function(i, value){
                            if (!value.validate) {
                                isCorrect = false;
                            }
                        })

                        if (isCorrect) {
                            console.log('WIN')
                        } else {
                            console.log('T\'es nul');
                        }
                    })

                    //Change input
                    $('input[type=range]').on("input", function(){

                        var name = $(this).attr('class');
                        var thisColors = $('.pixelActive').data('rvb');

                        switch(name) {
                            case 'red':
                                $(this).parent().css('background-color', 'rgb('+$(this).val()+', 0, 0)');
                                break;
                            case 'green': 
                                $(this).parent().css('background-color', 'rgb(0, '+$(this).val()+', 0)');
                                break;
                            case 'blue':
                                $(this).parent().css('background-color', 'rgb(0, 0, '+$(this).val()+')');
                                break;
                            default:
                                break;
                        }



                        thisColors[name] = $(this).val();
                        applyColor(thisColors);
                    })

                    $('input[type=range]').on("change", function(){
                        verif();

                    })

                    myCodeMirror.on('focus', function(){
                        myCodeMirror.setCursor({line:0,ch:0});
                        setSelection('number');
                    })

                    //cm.addKeyMap(map: object, bottom: boolean)
                    // OU
                    //extraKeys: Dans la config du CM
                    myCodeMirror.addKeyMap({
                        Enter: function(cm) {
                            setSelection('number');
                        }
                    });
                })


                function setSelection(varType) {
                    var setPos = true;
                    var cm = myCodeMirror;
                    var currentPos = cm.getCursor();
                    var line = currentPos.line;
                    //Commencer la recherche en début de ligne suivante si le curseur est en fin de ligne
                    if (currentPos.ch == cm.getLine(line).length) {
                        line++;
                        currentPos.ch = 0;
                    }
                    var tokens = cm.getLineTokens(line);
                    var i = 0;
                    //Commencer la recherche après la position actuelle du curseur
                    while (tokens[i].end <= currentPos.ch) {
                        i++;
                    }
                    if (tokens[i].type == varType) {
                        i++;
                    }
                    if (typeof tokens[i] == 'undefined') {
                        i = 0;
                        line++
                        tokens = cm.getLineTokens(line)
                    }
                    while (tokens[i].type != varType) {
                        i++
                        if (typeof tokens[i] == 'undefined') {
                            i = 0;
                            line++
                            tokens = cm.getLineTokens(line)
                        }
                        if (line > myCodeMirror.lineCount()) {
                            setPos = false;
                            //console.log('should run code')
                            break;
                        }
                    }
                    //console.log('oui')
                    if (setPos) {
                        cm.setSelection({line:line,ch:tokens[i].start},{line:line,ch:tokens[i].end});
                    } else {
                        console.log('runcode')
                        if ($('.cm-number').length != 3) {
                            alertErr();
                            //console.log('nope')
                        } else {
                            runCode();
                            myCodeMirror.getInputField().blur();
                        }
                    }
                    //console.log(tokens[i])
                }



                function alertErr() {
                    var pixel = $('.pixelActive').data('rvb');
                    resetCode('pixel' + $('.pixelActive').index(), pixel.red, pixel.green, pixel.blue)
                    myCodeMirror.getInputField().blur();
                    myCodeMirror.focus();
                    alert('ERROR');
                }

                function runCode() {
                    console.log('running code')
                    var code = myCodeMirror.getValue();
                    eval(code)

                    pixel = eval('pixel' + $('.pixelActive').index());
                    //console.log(pixel)                    

                    $.each(pixel, function(i, value) {
                        if (value < 0) {
                            pixel[i] = 0;
                        }
                        if (value > 255) {
                            pixel[i] = 255;
                        }
                    });


                    $('.pixelActive').data('rvb', {red: pixel.red, green: pixel.green, blue: pixel.blue});

                    resetSliders(pixel.red, pixel.green, pixel.blue);

                    applyColor(pixel);
                    verif();


                }

                function applyColor(pixel) {
                    resetCode('pixel' + $('.pixelActive').index(), pixel.red, pixel.green, pixel.blue);
                    colorPixel(pixel);        
                }

                function verif() {
                    var rvb = $('.pixelActive').data('rvb');

                    //console.log(rvb)
                    //console.log(answers[$('.pixelActive').index()]);

                    var thisAnswer = answers[$('.pixelActive').index()];
                    var ok = true;

                    $.each(thisAnswer, function(i, value){
                        console.log(value);
                        if (value.length > 1) {
                            if (rvb[i] < value[0] || rvb[i] > value[1]) {
                                ok = false;
                            }  
                        } else {
                            if (rvb[i] != value[0]) {
                                ok = false;
                            }
                        }    
                    })

                    if (ok) {
                        console.log('right');

                        answers[$('.pixelActive').index()].validate = true;

                    } else {
                        console.log('nope');
                        //Est-ce que l'utilisateur peut changer les variables une fois que le carré a été validé?

                        answers[$('.pixelActive').index()].validate = false;

                    }
                }


                function colorPixelRVB(pixel) {
                    //console.log(pixel)
                    var red = 0,
                        green = 0,
                        blue = 0;
                    if (pixel.red) { red = 255; }
                    if (pixel.green) { green = 255; }
                    if (pixel.blue) { blue = 255; }
                    $('.pixelActive').css('background-color', 'rgb('+ red +', '+ green +', '+ blue +')');
                }

                function colorPixel(pixel) {
                    $('.pixelActive').css('background-color', 'rgb('+pixel.red+', '+pixel.green+', '+pixel.blue+')');
                }

                function resetCode(id, r, g, b) {
                    myCodeMirror.setValue('var ' + id + ' = {\n\tred : ' + r + ',\n\tgreen : ' + g + ',\n\tblue : ' + b + '\n}');
                    myCodeMirror.markText({line:0,ch:0},{line:1,ch:7},{readOnly:true})
                    myCodeMirror.markText({line:2,ch:0},{line:2,ch:9},{readOnly:true})
                    myCodeMirror.markText({line:3,ch:0},{line:3,ch:8},{readOnly:true})
                    myCodeMirror.markText({line:4,ch:0},{line:5,ch:0},{readOnly:true})  
                }

                function resetSliders(r, g, b) {
                    $('input.red').val(r).parent().css('background-color', 'rgb('+r+', 0, 0)')
                    $('input.green').val(g).parent().css('background-color', 'rgb(0, '+g+', 0)')
                    $('input.blue').val(b).parent().css('background-color', 'rgb(0, 0, '+b+')')

                }

                function reset() {
                    $('.pixel').off()
                    $('button').off()
                    $('input:checkbox').off()
                }
            });

        </script>
    </body>
</html>